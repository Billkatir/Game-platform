<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Login / Register</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 400px;
        margin: 2em auto;
        padding: 2em;
        border: 1px solid #ccc;
        border-radius: 8px;
      }
      input {
        display: block;
        width: 100%;
        margin: 1em 0;
        padding: 0.5em;
      }
      button {
        padding: 0.5em 1em;
      }
      #toggle {
        color: blue;
        cursor: pointer;
        text-decoration: underline;
        margin-top: 1em;
      }
      .hidden {
        display: none;
      }
    </style>
  </head>
  <body>
    <h2 id="form-title">Login</h2>
    <form id="auth-form">
      <input type="text" id="username" placeholder="Username" required />
      <input type="password" id="password" placeholder="Password" required />
      <input type="email" id="email" placeholder="Email" class="hidden" />

      <button type="submit">Submit</button>
    </form>

    <div id="toggle">Not signed in? Register</div>
    <pre id="output"></pre>

    <script>
      const form = document.getElementById("auth-form");
      const output = document.getElementById("output");
      const toggle = document.getElementById("toggle");
      const emailField = document.getElementById("email");
      const title = document.getElementById("form-title");

      let isLogin = true;

      toggle.onclick = () => {
        isLogin = !isLogin;
        emailField.classList.toggle("hidden");
        title.textContent = isLogin ? "Login" : "Register";
        toggle.textContent = isLogin
          ? "Not signed in? Register"
          : "Already registered? Login";
        output.textContent = "";
      };

      form.onsubmit = async (e) => {
        e.preventDefault();

        const username = document.getElementById("username").value.trim();
        const password = document.getElementById("password").value.trim();
        const email = document.getElementById("email").value.trim();

        let url = isLogin
          ? "http://127.0.0.1:8000/auth/login"
          : "http://127.0.0.1:8000/auth/register";

        let fetchOptions;

        if (isLogin) {
          // For login, send form-urlencoded data to match OAuth2PasswordRequestForm
          const formData = new URLSearchParams();
          formData.append("username", username);
          formData.append("password", password);

          fetchOptions = {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: formData.toString(),
          };
        } else {
          // For register, send JSON data
          const data = { username, password, email };
          fetchOptions = {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          };
        }

        try {
          const response = await fetch(url, fetchOptions);
          const result = await response.json();
          output.textContent = JSON.stringify(result, null, 2);

          if (response.ok) {
            if (isLogin && result.access_token) {
              // Save token and redirect to games page
              localStorage.setItem("token", result.access_token);
              window.location.href = "game.html";
            } else if (!isLogin) {
              // After register, show message and switch to login form
              output.textContent =
                "Registration successful! Redirecting to login...";
              setTimeout(() => {
                isLogin = true;
                emailField.classList.add("hidden");
                title.textContent = "Login";
                toggle.textContent = "Not signed in? Register";
                output.textContent = "";
                form.reset();
              }, 1500);
            }
          } else {
            output.textContent = result.detail || "Error occurred";
          }
        } catch (err) {
          output.textContent = "Network or server error: " + err.message;
        }
      };
    </script>
  </body>
</html>
